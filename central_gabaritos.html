<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin — Central de Gabaritos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f7f9fc; }
    header { background-color: #0d6efd; color: #fff; padding: 20px 0; text-align: center; margin-bottom: 30px; }
    table thead th { background-color: #0d6efd; color: #fff; text-align: center; }
    table tbody td { text-align: center; vertical-align: middle; }
    .btn-sm { font-size: 14px; padding: 4px 8px; }
  </style>
</head>
<body>
  <header>
    <h1>Painel Administrativo — Central de Gabaritos</h1>
    <p class="lead">Edição direta do dados.json no GitHub</p>
  </header>

  <div class="container">
    <div class="mb-3">
      <label class="form-label">Token Pessoal do GitHub (PAT)</label>
      <input type="password" id="tokenInput" class="form-control" placeholder="Cole aqui seu token GitHub">
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4 class="mb-0">Gerenciar Disciplinas</h4>
      <div>
        <button id="addRow" class="btn btn-primary btn-sm">Adicionar Linha</button>
        <button id="saveGitHub" class="btn btn-success btn-sm">Salvar no GitHub</button>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-bordered align-middle">
        <thead>
          <tr>
            <th>Data</th>
            <th>Semana</th>
            <th>Tema</th>
            <th>PDF</th>
            <th>Gabarito (JSON)</th>
            <th>Ação</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <tr><td colspan="6" class="text-center text-muted">Carregando...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const DATA_URL = 'https://janeladosport.github.io/gabaritofichas/dados.json';
    const API_URL = 'https://api.github.com/repos/janeladosport/gabaritofichas/contents/dados.json';

    let dados = { disciplinas: [] };
    let currentSha = null;

    async function carregarDados() {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Carregando...</td></tr>';

      try {
        const res = await fetch(DATA_URL);
        if (!res.ok) throw new Error('Erro ao carregar JSON');
        const data = await res.json();
        dados = data;

        // buscar SHA atual
        const shaRes = await fetch(API_URL);
        const shaData = await shaRes.json();
        currentSha = shaData.sha;

        render();
      } catch (err) {
        document.getElementById('tableBody').innerHTML = `<tr><td colspan='6' class='text-danger text-center'>Erro: ${err.message}</td></tr>`;
      }
    }

    function render() {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';
      if (!dados.disciplinas || dados.disciplinas.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Nenhum dado encontrado.</td></tr>';
        return;
      }

      dados.disciplinas.forEach((d, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type='text' class='form-control form-control-sm' value='${d.data || ''}' data-i='${i}' data-f='data'></td>
          <td><input type='number' class='form-control form-control-sm' value='${d.semana || ''}' data-i='${i}' data-f='semana'></td>
          <td><input type='text' class='form-control form-control-sm' value='${d.tema || ''}' data-i='${i}' data-f='tema'></td>
          <td><input type='text' class='form-control form-control-sm' value='${d.pdf || ''}' data-i='${i}' data-f='pdf'></td>
          <td><input type='text' class='form-control form-control-sm' value='${d.gabarito || ''}' data-i='${i}' data-f='gabarito'></td>
          <td><button class='btn btn-outline-danger btn-sm' onclick='remover(${i})'>Excluir</button></td>
        `;
        tbody.appendChild(tr);
      });

      document.querySelectorAll('input').forEach(inp => {
        inp.addEventListener('change', e => {
          const i = e.target.dataset.i;
          const f = e.target.dataset.f;
          dados.disciplinas[i][f] = e.target.value;
        });
      });
    }

    function remover(i) {
      dados.disciplinas.splice(i, 1);
      render();
    }

    document.getElementById('addRow').addEventListener('click', () => {
      if (!dados.disciplinas) dados.disciplinas = [];
      dados.disciplinas.push({ data: '', semana: '', tema: '', pdf: '', gabarito: '' });
      render();
    });

    document.getElementById('saveGitHub').addEventListener('click', async () => {
      
      const token = document.getElementById('tokenInput').value.trim();
      if (!token) return alert('Informe seu token GitHub primeiro.');

      try {
        const conteudo = JSON.stringify(dados, null, 2);
        const conteudoBase64 = btoa(unescape(encodeURIComponent(conteudo)));

        const res = await fetch(API_URL, {
          method: 'PUT',
          headers: {
            Authorization: `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: 'Atualização via painel admin',
            content: conteudoBase64,
            sha: currentSha
          })
        });

        if (!res.ok) throw new Error('Erro ao salvar no GitHub.');
        alert('Arquivo atualizado com sucesso no GitHub!');
        carregarDados();
      } catch (err) {
        alert('Erro: ' + err.message);
      }
    });

    carregarDados();
  </script>
</body>
</html>