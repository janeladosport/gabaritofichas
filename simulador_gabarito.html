<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gerenciador de Gabarito — Simulador</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{background:#f8fafc;padding:20px}
    .star{cursor:pointer;font-size:18px}
    .star.checked{color:gold}
    .correct{background:#198754;color:#fff}
    .wrong{background:#dc3545;color:#fff}
    .question-card{transition:box-shadow .15s;border-radius:8px}
  </style>
</head>
<body>
  <div class="container">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h1 class="h4">Gerenciador de Gabarito — Simulador</h1>
      <div>
        <button id="exportBtn" class="btn btn-outline-secondary btn-sm">Exportar JSON</button>
        <button id="importBtn" class="btn btn-outline-secondary btn-sm">Importar JSON</button>
        <button id="clearBtn" class="btn btn-outline-danger btn-sm">Limpar tudo</button>
      </div>
    </div>

    <div class="card p-3 mb-3 question-card">
      <div class="row g-2 align-items-center">
        <div class="col-md-6">
          <label class="form-label mb-0">Adicionar questões (uma por linha) — formato: num|codigo (ex: 1|1963019)</label>
          <textarea id="bulkInput" class="form-control" rows="3" placeholder="1|1963019\n2|1963020\n..."></textarea>
        </div>
        <div class="col-md-6 d-flex gap-2">
          <div>
            <label class="form-label mb-0">Alternativa padrão para todas</label>
            <select id="defaultAlt" class="form-select">
              <option value="">-- nenhuma --</option>
              <option value="A">A</option>
              <option value="B">B</option>
              <option value="C">C</option>
              <option value="D">D</option>
              <option value="E">E</option>
            </select>
          </div>
          <div class="align-self-end">
            <button id="addBulk" class="btn btn-primary" style="margin-bottom:4px">Adicionar</button>
            <div class="form-text">Após adicionar, as questões aparecem abaixo.</div>
          </div>
        </div>
      </div>
    </div>

    <div id="questionsList" class="mb-3"></div>

    <div class="card p-3 mb-3">
      <h6>Modo de uso rápido</h6>
      <ul>
        <li>Clique em <strong>Definir</strong> para registrar o gabarito de cada questão.</li>
        <li>Escreva a resposta do aluno (A–E) no campo "Resposta" e pressione <strong>Verificar</strong>.</li>
        <li>Use <strong>Exportar JSON</strong> para salvar o gabarito e carregue depois com <strong>Importar JSON</strong>.</li>
      </ul>
    </div>

    <div class="card p-3 mb-5">
      <h6>Export / Import preview</h6>
      <textarea id="preview" class="form-control" rows="6" readonly></textarea>
    </div>

    <footer class="text-muted small">Feito por você + ChatGPT — salva localmente (localStorage).</footer>
  </div>

<script>
// Estrutura em localStorage: { questions: [{num:1, code:'1963019', answer:'A', stars:0, note:''}], createdAt:... }
const STORAGE_KEY = 'simulador_gabarito_v1';

function loadState(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return {questions:[], createdAt: Date.now()};
  try { return JSON.parse(raw); } catch(e){ return {questions:[], createdAt: Date.now()}; }
}

function saveState(state){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); render(); }

let state = loadState();

function render(){
  state = loadState();
  const container = document.getElementById('questionsList');
  container.innerHTML = '';
  if(state.questions.length===0){ container.innerHTML = '<div class="alert alert-info">Nenhuma questão cadastrada.</div>'; document.getElementById('preview').value=''; return; }

  state.questions.sort((a,b)=> a.num - b.num);

  state.questions.forEach((q, idx)=>{
    const div = document.createElement('div');
    div.className = 'card p-3 mb-2 question-card';
    div.innerHTML = `
      <div class="row g-2 align-items-center">
        <div class="col-md-1"><strong>${q.num}</strong></div>
        <div class="col-md-2"><input class="form-control form-control-sm" value="${escapeHTML(q.code||'')}" data-idx="${idx}" data-field="code"></div>
        <div class="col-md-2">
          <select class="form-select form-select-sm" data-idx="${idx}" data-field="answer">
            <option value="">- gabarito -</option>
            <option ${q.answer==='A'?'selected':''}>A</option>
            <option ${q.answer==='B'?'selected':''}>B</option>
            <option ${q.answer==='C'?'selected':''}>C</option>
            <option ${q.answer==='D'?'selected':''}>D</option>
            <option ${q.answer==='E'?'selected':''}>E</option>
          </select>
        </div>
        <div class="col-md-2"><input maxlength="1" class="form-control form-control-sm student-answer" placeholder="Resposta" data-idx="${idx}"></div>
        <div class="col-md-3">
          <button class="btn btn-sm btn-success me-1 setBtn" data-idx="${idx}">Definir</button>
          <button class="btn btn-sm btn-primary me-1 checkBtn" data-idx="${idx}">Verificar</button>
          <button class="btn btn-sm btn-outline-secondary exportRow" data-idx="${idx}">Export</button>
          <button class="btn btn-sm btn-outline-danger deleteBtn float-end" data-idx="${idx}">Excluir</button>
        </div>
        <div class="col-md-12 mt-2">
          <div class="d-flex align-items-center gap-2">
            <div class="stars" data-idx="${idx}">${renderStars(q.stars||0)}</div>
            <small class="text-muted">Código: ${escapeHTML(q.code||'—')}</small>
            <div class="ms-auto"><small class="text-muted">Nota: <span class="noteText">${escapeHTML(q.note||'')}</span></small></div>
          </div>
        </div>
      </div>
    `;
    container.appendChild(div);
  });

  document.querySelectorAll('[data-field="code"]').forEach(inp=>{
    inp.addEventListener('change', (e)=>{
      const i = +e.target.getAttribute('data-idx'); state.questions[i].code = e.target.value.trim(); saveState(state);
    });
  });

  document.querySelectorAll('[data-field="answer"]').forEach(sel=>{
    sel.addEventListener('change', (e)=>{
      const i = +e.target.getAttribute('data-idx'); state.questions[i].answer = e.target.value; saveState(state);
    });
  });

  document.querySelectorAll('.setBtn').forEach(btn=> btn.addEventListener('click', (e)=>{
    const i = +e.target.getAttribute('data-idx');
    // já mudou no select; apenas flash
    alert('Gabarito salvo: ' + (state.questions[i].answer || '—'));
    saveState(state);
  }))

  document.querySelectorAll('.checkBtn').forEach(btn=> btn.addEventListener('click', (e)=>{
    const i = +e.target.getAttribute('data-idx');
    const input = document.querySelector('.student-answer[data-idx="'+i+'"]');
    const resp = (input.value||'').toUpperCase().trim();
    if(!resp.match(/^[A-E]$/)){ alert('Digite A, B, C, D ou E'); return; }
    const correct = (state.questions[i].answer||'').toUpperCase();
    if(!correct){ alert('Gabarito não definido para esta questão'); return; }
    if(resp === correct){ input.classList.add('correct'); input.classList.remove('wrong'); alert('Acertou!'); }
    else { input.classList.add('wrong'); input.classList.remove('correct'); alert('Errou. Gabarito: '+correct); }
  }))

  document.querySelectorAll('.exportRow').forEach(btn=> btn.addEventListener('click', (e)=>{
    const i = +e.target.getAttribute('data-idx');
    const text = JSON.stringify(state.questions[i], null, 2);
    document.getElementById('preview').value = text;
  }))

  document.querySelectorAll('.deleteBtn').forEach(btn=> btn.addEventListener('click', (e)=>{
    const i = +e.target.getAttribute('data-idx');
    if(confirm('Excluir questão '+state.questions[i].num+'?')){
      state.questions.splice(i,1); saveState(state);
    }
  }))

  // stars
  document.querySelectorAll('.stars').forEach(div=>{
    const i = +div.getAttribute('data-idx');
    div.querySelectorAll('.star').forEach((s, si)=> s.addEventListener('click', ()=>{
      state.questions[i].stars = si+1; saveState(state);
    }))
  });

  // preview full
  document.getElementById('preview').value = JSON.stringify(state, null, 2);
}

function renderStars(n){ let html=''; for(let i=1;i<=5;i++) html += `<span class="star ${i<=n?'checked':''}">&#9733;</span>`; return html; }
function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m]; }); }

// bulk add
document.getElementById('addBulk').addEventListener('click', ()=>{
  const txt = document.getElementById('bulkInput').value.trim();
  if(!txt){ alert('Coloque dados para adicionar'); return; }
  const lines = txt.split('\n').map(l=>l.trim()).filter(Boolean);
  const def = document.getElementById('defaultAlt').value;
  lines.forEach(l=>{
    const parts = l.split('|').map(p=>p.trim());
    const num = parseInt(parts[0],10);
    const code = parts[1] || '';
    if(Number.isNaN(num)) return;
    state.questions.push({ num: num, code: code, answer: def||'', stars:0, note: '' });
  });
  saveState(state);
});

// export/import
document.getElementById('exportBtn').addEventListener('click', ()=>{
  const dataStr = JSON.stringify(state, null, 2);
  const blob = new Blob([dataStr], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'gabarito.json'; a.click(); URL.revokeObjectURL(url);
});

document.getElementById('importBtn').addEventListener('click', ()=>{
  const input = document.createElement('input'); input.type='file'; input.accept='application/json';
  input.onchange = e=>{
    const file = e.target.files[0]; if(!file) return; const reader = new FileReader();
    reader.onload = ev=>{
      try{ const obj = JSON.parse(ev.target.result); if(obj.questions && Array.isArray(obj.questions)){ state = obj; saveState(state); alert('Importado com sucesso'); } else alert('Arquivo inválido'); }
      catch(err){ alert('Erro ao ler JSON: '+err.message); }
    };
    reader.readAsText(file);
  };
  input.click();
});

// clear
document.getElementById('clearBtn').addEventListener('click', ()=>{
  if(confirm('Limpar todas as questões e dados locais?')){ state = {questions:[], createdAt: Date.now()}; saveState(state); }
});

// initial render
render();

</script>
</body>
</html>
