<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Página do Aluno — Simulador de Gabarito</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    body{background-color:#f7f9fc;}
    .table-striped tbody tr:nth-of-type(odd){background-color:#f2f2f2;}
    .table-striped tbody tr:nth-of-type(even){background-color:#ffffff;}
    .table-striped tbody tr:hover{background-color:#cfe2ff;}
    .table thead th{background-color:#0d6efd;color:white;text-align:center;}
    .table tbody td{text-align:center;vertical-align:middle;}
    .correct{background:#198754!important;color:#fff!important}
    .wrong{background:#dc3545!important;color:#fff!important}
    .btn-import{font-size:14px;padding:6px 12px;}
    header{background-color:#0d6efd;color:white;text-align:center;padding:20px 0;margin-bottom:20px;}
    header h1, header h2{margin:0;}
    .fa-star{color:#ddd;cursor:pointer;}
    .fa-star.checked{color:#ffc107;}
    .resp{
      width:45px;
      height:40px;
      text-transform:uppercase;
      text-align:center;
      font-size:16px;
      margin:auto;
    }
    strong{
      font-weight: normal;
    }
  </style>
</head>
<body>
  <header>
    <img src="https://online.academiafernandinhobeltrao.com.br/online/portal/plugins/images/favicon.png" alt="Logo" width="50">
    <h1>Academia Fernandinho Beltrão</h1>
    <h2 id="name"></h2>
    <p class="lead">Isoladas 2025</p>
  </header>

  <div class="container">
    <div class="d-flex justify-content-between mb-3">
      <div>
        <button id="importBtn" class="btn btn-primary btn-import"><i class="fa fa-upload"></i> Importar gabarito JSON</button>
      </div>
      <div id="score" class="fw-bold text-primary"></div>
    </div>

    <div class="table-responsive">
      <table id="questionsTable" class="table table-striped table-bordered align-middle">
        <thead>
          <tr>
            <th>Questão</th>
            <th>Resposta</th>
            <th>Gabarito</th>
            <th>Cod</th>
            <th>★</th>
          </tr>
        </thead>
        <tbody id="questionsBody"></tbody>
      </table>
    </div>
  </div>

<script>
let gabarito = null;
// --- auto-load JSON quando ?file=... estiver presente na URL ---
async function tryLoadFromQueryParam() {
  try {
    const params = new URLSearchParams(window.location.search);
    const fileParam = params.get('file');
    if (!fileParam) return; // nada para fazer

    // pode vir codificado (https%3A...), vamos decodificar
    const url = decodeURIComponent(fileParam);


    const res = await fetch(url);
    if (!res.ok) throw new Error(`Falha ao carregar JSON (status ${res.status})`);
    const obj = await res.json();

    // validar estrutura básica
    if (!obj.questions || !Array.isArray(obj.questions)) {
      throw new Error('JSON não contém "questions" (formato inválido).');
    }

    // atribui e renderiza
    gabarito = obj;
    render();

    // opcional: desabilita o botão de importar para evitar confusão
    const importBtn = document.getElementById('importBtn');
    if (importBtn) importBtn.remove();

  } catch (err) {
    console.error('Erro ao carregar gabarito via query param:', err);
    // mostra msg amigável
    const tbody = document.getElementById('questionsBody');
    if (tbody) tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Erro ao carregar gabarito: ${err.message}</td></tr>`;
    const scoreEl = document.getElementById('score');
    if (scoreEl) scoreEl.textContent = '';
  }
}

// chama ao carregar a página
tryLoadFromQueryParam();

function render(){
  const tbody = document.getElementById('questionsBody');
  tbody.innerHTML = '';
  if(!gabarito || !gabarito.questions || gabarito.questions.length===0){
    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Nenhum gabarito carregado ainda.</td></tr>';
    document.getElementById('score').textContent = '';
    return;
  }

  if(gabarito.name){
  document.getElementById("name").innerHTML = gabarito.name}

  gabarito.questions.sort((a,b)=>a.num-b.num);

  gabarito.questions.forEach((q,idx)=>{
    const numeroQuestao = idx + 1; // número sequencial
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${numeroQuestao}</td>
      <td><input type="text" maxlength="1" class="resp" data-idx="${idx}"></td>
      <td class="gabarito"></td>
      <td>${q.code || '—'}</td>
      <td class="stars">${renderStars(q.stars||0, idx)}</td>
    `;
    tbody.appendChild(tr);
  });

  document.querySelectorAll('.resp').forEach(input=>{
    input.addEventListener('keyup', e=>{
      const val = (e.target.value||'').toUpperCase().trim();
      if(val.match(/^[A-E]$/)){
        if(confirm('Deseja confirmar a resposta digitada?')){
          verificar(e.target);
        } else {
          e.target.value = '';
        }
      }
    });
  });

  document.querySelectorAll('.fa-star').forEach(star=>{
    star.addEventListener('click', ()=>{
      const idx = +star.dataset.idx;
      const val = +star.dataset.val;
      gabarito.questions[idx].stars = val;
      render();
    });
  });
}

function verificar(input){
  const idx = +input.getAttribute('data-idx');
  const val = (input.value||'').toUpperCase().trim();
  const tr = input.closest('tr');
  const gabTd = tr.querySelector('.gabarito');
  const certo = (gabarito.questions[idx].answer||'').toUpperCase();

  if(val===certo){
    input.classList.add('correct');
    input.classList.remove('wrong');
    gabTd.textContent = certo;
  } else {
    input.classList.add('wrong');
    input.classList.remove('correct');
    gabTd.textContent = certo;
  }
  atualizarPontuacao();
}

function atualizarPontuacao(){
  const total = gabarito.questions.length;
  let certos = 0;
  document.querySelectorAll('.resp').forEach((inp)=>{
    if(inp.classList.contains('correct')) certos++;
  });
  document.getElementById('score').textContent = `Pontuação: ${certos}/${total}`;
}

function renderStars(n, idx){
  let html='';
  for(let i=1;i<=5;i++){
    html += `<i class='fa fa-star ${i<=n?'checked':''}' data-idx='${idx}' data-val='${i}'></i>`;
  }
  return html;
}

document.getElementById('importBtn').addEventListener('click', ()=>{
  const input = document.createElement('input');
  input.type='file'; input.accept='application/json';
  input.onchange = e=>{
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = ev=>{
      try{
        const obj = JSON.parse(ev.target.result);
        if(obj.questions && Array.isArray(obj.questions)){
          gabarito = obj; render(); 
        } else alert('Arquivo inválido.');
      }catch(err){ alert('Erro ao ler JSON: '+err.message); }
    };
    reader.readAsText(file);
  };
  input.click();
});

// tenta carregar via ?file=... ; caso não haja, renderiza normalmente
tryLoadFromQueryParam().then(() => {
  if (!gabarito) render(); // se não veio via query param, continua com o comportamento normal
});

</script>
</body>
</html>
